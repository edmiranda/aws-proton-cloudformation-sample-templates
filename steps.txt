########Â Establecer Permisos ########

aws iam create-role --role-name AWSProtonCodeBuildProvisioning --assume-role-policy-document '{"Version":"2012-10-17","Statement":[{"Effect":"Allow","Principal":{"Service":"codebuild.amazonaws.com"},"Action":"sts:AssumeRole"}]}'
aws iam attach-role-policy --role-name AWSProtonCodeBuildProvisioning --policy-arn arn:aws:iam::aws:policy/AWSProtonCodeBuildProvisioningBasicAccess

######## Registrar una plantilla de entorno ########

aws proton create-environment-template \
  --name "fargate-env" \
  --display-name "Public VPC Fargate" \
  --description "VPC with public access and ECS cluster"

aws proton create-template-sync-config \
  --template-name "fargate-env" \
  --template-type "ENVIRONMENT" \
  --repository-name "edmiranda/aws-proton-cloudformation-sample-templates" \
  --repository-provider "GITHUB" \
  --branch "main" \
  --subdirectory "environment-templates/fargate-env"

aws proton update-environment-template-version \
  --template-name "fargate-env" \
  --major-version "1" \
  --minor-version "0" \
  --status "PUBLISHED"

######## Registrar una plantilla de servicio ########

aws proton create-service-template \
  --name "load-balanced-fargate-svc" \
  --display-name "Load balanced Fargate service" \
  --description "Fargate service with an application load balancer"

aws proton create-template-sync-config \
  --template-name "load-balanced-fargate-svc" \
  --template-type "SERVICE" \
  --repository-name "edmiranda/aws-proton-cloudformation-sample-templates" \
  --repository-provider "GITHUB" \
  --branch "main" \
  --subdirectory "service-templates/load-balanced-fargate-svc"

aws proton update-service-template-version \
  --template-name "load-balanced-fargate-svc" \
  --major-version "1" \
  --minor-version "0" \
  --status "PUBLISHED"

######## Implementar un entorno ########

aws proton create-environment \
  --name "fargate-env-prod" \
  --template-name "fargate-env" \
  --template-major-version 1 \
  --proton-service-role-arn "arn:aws:iam::597345313373:role/service-role/aws-proton-poc" \
  --spec "file://environment-templates/fargate-env/spec/spec.yaml"


######## Implementar un servicio ########

aws proton create-service \
  --name "static-website" \
  --repository-connection-arn \
    "arn:aws:codestar-connections:us-east-1:597345313373:connection/ad5d29e9-3d3e-40ed-8986-aec764413345" \
  --repository-id "edmiranda/aws-proton-cloudformation-sample-templates/service-templates" \
  --branch-name "main" \
  --template-major-version 1 \
  --template-name "load-balanced-fargate-svc" \
  --spec "file://service-templates/load-balanced-fargate-svc/spec/spec.yaml"

  aws proton list-service-instance-outputs \
  --service-name "static-website" \
  --service-instance-name load-balanced-fargate-svc-prod

  ######## Clean ########

aws proton delete-service --name "static-website"

aws proton delete-environment --name "fargate-env-prod"

aws proton delete-service-template-version --template-name "load-balanced-fargate-svc" --major-version "1" --minor-version "0"

aws proton delete-service-template --name "load-balanced-fargate-svc"

aws proton delete-environment-template-version --template-name "fargate-env" --major-version "1" --minor-version "0"

aws proton delete-environment-template --name "fargate-env"
